<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Article</title>
  <meta name="viewport" content="width=800">
  <style>
    body{background:#f2f2f2; font-family: Arial, Helvetica, sans-serif; margin:0; padding:0;}
    .container{width:800px; margin:20px auto; background:#fff; border:4px solid #c0c0c0}
    .header{background:#336699; padding:12px; color:#fff;}
    .logo{float:left; font-size:24px; font-weight:bold;}
    .nav{float:right; text-align:right; font-size:12px}
    .clear{clear:both}
    .content{padding:14px}
    .intro{font-size:14px; color:#333; margin-bottom:20px;}
    .list-item{border-top:1px dashed #999; padding:12px 0;}
    .item-number{font-size:48px; font-weight:bold; float:left; width:70px; color:#b21}
    .item-body{margin-left:90px}
    .item-title{font-size:18px; font-weight:bold; margin-bottom:8px;}
    .item-text{line-height:1.6;}
    .sidebar{background:#fafafa; border-left:3px solid #ddd; padding:10px; font-size:12px}
    .footer{background:#f6f6f6; text-align:center; padding:8px; font-size:12px; border-top:1px solid #ddd}
    .comments-section{padding:14px; border-top:2px solid #ccc; background:#fafafa}
    .comment{border-bottom:1px dashed #aaa; padding:8px 0; font-size:13px}
    .comment strong{color:#b21}
    a {color:#0066cc; text-decoration:none}
    a:hover {text-decoration:underline}
    
    /* Glitch effects */
    .glitch {
      animation: glitch 0.3s infinite;
    }
    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); color: #ff0000; }
      40% { transform: translate(-2px, -2px); color: #00ff00; }
      60% { transform: translate(2px, 2px); color: #0000ff; }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    
    .flicker {
      animation: flicker 0.5s infinite;
    }
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .grow {
      animation: grow 1s ease-in-out;
    }
    @keyframes grow {
      0% { font-size: inherit; }
      50% { font-size: 200%; }
      100% { font-size: inherit; }
    }
    
    .empty-item {
      background: #fff5f5;
      font-style: italic;
      color: #999;
      min-height: 60px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      flex-direction: column;
    }
    .loading-text {
      margin-top: 20px;
      font-family: 'Courier New', monospace;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div>üëÅÔ∏è</div>
    <div class="loading-text">Analyzing your patterns...</div>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo">RetroNet Articles</div>
      <div class="nav">
        <div style="margin-bottom:6px;">Home | Lists | Contact</div>
        <div style="font-size:11px; color:#ccc">By <strong id="author-name">Author</strong> | <span id="article-date">Date</span></div>
      </div>
      <div class="clear"></div>
    </div>

    <table width="100%" cellpadding="0" cellspacing="12">
      <tr>
        <td width="65%" valign="top">
          <div class="content">
            <h1 style="margin:6px 0; font-size:28px; color:#b21" id="article-title">Loading...</h1>
            <div class="intro" id="article-intro">Analyzing your behavior...</div>

            <div id="listicle-items"></div>

            <div class="comments-section" id="comments">
              <h2 style="color:#b21; font-size:20px;">Comments (<span id="comment-count">10</span>)</h2>
              <div id="comments-list"></div>
            </div>
          </div>
        </td>
        <td width="35%" valign="top">
          <div class="sidebar">
            <h3 style="margin-top:0">Related Articles</h3>
            <div id="sidebar-links"></div>
            <hr>
            <h4>Subscribe</h4>
            <form action="#" method="post">
              <input type="text" name="email" size="20" value="you@example.com"><br><br>
              <input type="submit" value="Subscribe">
            </form>
          </div>
        </td>
      </tr>
    </table>

    <div class="footer">
      <div style="margin-top:6px">&copy; <span id="footer-year">2025</span> RetroNet | <a href="#">Privacy</a> | <a href="#">Terms</a></div>
    </div>
  </div>

  <script src="core-system.js"></script>
  <script>
    console.log('=== PAGE 2 STARTED ===');
    
    // Check if core system loaded
    if (typeof HypertextCore === 'undefined') {
      console.error('ERROR: core-system.js not loaded!');
      document.getElementById('loading-overlay').innerHTML = 
        '<div style="color:red;">ERROR: core-system.js not found</div>';
    } else {
      initializePage();
    }

    async function initializePage() {
      // Track page visit
      HypertextCore.trackPageVisit('Act2_Article');

      // Get user data
      const userGoals = HypertextCore.getUserGoals() || 'achieve your goals';
      const userInterests = HypertextCore.getUserInterests() || ['Gaming', 'Technology'];
      const userFavourites = HypertextCore.getUserFavourites() || ['Minecraft', 'Coding'];
      const sessionId = HypertextCore.sessionId || 'USER_000000';

      console.log('User data:', { userGoals, userInterests, userFavourites });

      // Update basic info
      document.getElementById('author-name').textContent = generateAuthorName(userInterests);
      document.getElementById('article-date').textContent = new Date().toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
      document.getElementById('footer-year').textContent = new Date().getFullYear();

      // Generate article title
      const articleTitle = `10 Signs You're Avoiding What You Really Want`;
      document.getElementById('article-title').textContent = articleTitle;
      document.getElementById('article-intro').textContent = 
        `If you've been thinking about "${userGoals}", you're not alone. But the patterns might be more predictable than you think.`;

      // Generate listicle with API
      const items = await generateEerieListicle(userGoals, userInterests, userFavourites);

      // Hide loading overlay
      document.getElementById('loading-overlay').classList.add('hidden');

      // Render listicle
      renderListicle(items);

      // Generate comments
      generateComments(userGoals, userInterests, sessionId);

      // Generate sidebar
      generateSidebar(userGoals, userInterests);

      // Apply glitch effects
      setTimeout(applyGlitchEffects, 2000);

      // Auto-scroll and redirect
      setupAutoScroll();
    }

    function generateAuthorName(interests) {
      const firstNames = ['Alex', 'Jordan', 'Casey', 'Morgan', 'Riley', 'Taylor'];
      const lastNames = ['Chen', 'Rodriguez', 'Kim', 'Patel', 'Johnson', 'Martinez'];
      return `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
    }

    async function generateEerieListicle(userGoals, userInterests, userFavourites) {
      const apiKey = localStorage.getItem('claudeApiKey');
      
      // Check cache first
      const cachedItems = localStorage.getItem('listicleItems_' + userGoals);
      if (cachedItems) {
        console.log('Using cached listicle items');
        return JSON.parse(cachedItems);
      }

      if (!apiKey) {
        console.log('No API key, using fallback items');
        return getFallbackItems(userGoals, userInterests, userFavourites);
      }

      const currentTime = new Date().toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
      });

      try {
        console.log('Calling Claude API to generate eerie listicle...');
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [{
              role: 'user',
              content: `The user was asked an unsettling question that implied observation and awareness. They answered: "${userGoals}"

Context:
- User's answer: ${userGoals}
- User's interests: ${userInterests.join(', ')}
- User's favourites: ${userFavourites.join(', ')}
- Location: Metro Manila, Philippines
- Time: ${currentTime}
- Setting: Ateneo de Manila University

Generate 10 listicle items that feel increasingly invasive and unsettling. The tone should be like an algorithm that knows too much.

EXACT STRUCTURE:

Items 1-3: Generic, relatable observations (normal tone)
- Keep these broad and applicable to anyone
- 2-3 sentences each
- Slightly knowing tone but not creepy yet

Item 4: Getting specific
- Reference their answer "${userGoals}" AND one of their interests: ${userInterests[0]} or ${userFavourites[0]}
- Make the connection feel uncomfortably accurate
- 2-3 sentences

Item 5: TITLE ONLY
- Title: "You've Read This Before"
- Body: [LEAVE COMPLETELY EMPTY - just write nothing after the |]

Item 6: Uncomfortably specific
- Directly address them as a Filipino college student in Metro Manila
- Reference "${userGoals}" in a way that feels invasive
- Mention the late hour (${currentTime})
- Make it feel like surveillance
- 3-4 sentences

Item 7: TITLE ONLY
- Title: "I feel like I've read this before."
- Body: [LEAVE COMPLETELY EMPTY - just write nothing after the |]

Items 8-9: Back to generic (but with lingering unease)
- Return to broader observations
- Maintain slight edge of awareness
- 2-3 sentences each

Item 10: Extremely specific and meta
- Reference sitting in a classroom at Ateneo de Manila University
- Mention their creative project or assignment
- Reference "${userGoals}" as something they're avoiding right now
- Break the fourth wall - acknowledge this is an article they're reading instead of working
- Make it feel like the algorithm is watching them in real-time
- 4-5 sentences

FORMAT EXACTLY AS:
Title | Body

For items 5 and 7, format as:
Title | 

TONE GUIDELINES:
- Items 1-3: Observant but friendly
- Item 4: Starting to feel too accurate
- Item 5: Empty creates unease
- Item 6: Invasive, like being watched
- Item 7: Empty reinforces d√©j√† vu
- Items 8-9: Trying to return to normal but can't
- Item 10: Full surveillance reveal, meta-aware

Make the progression feel like slowly realizing you're being observed.`
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.content[0].text;
        
        console.log('API response received');
        
        // Parse response
        const lines = content.trim().split('\n').filter(line => line.includes('|'));
        const items = lines.map((line, index) => {
          const [title, body] = line.split('|').map(s => s.trim());
          return { 
            title: title.replace(/^\d+\.\s*/, ''), 
            body: body || '',
            isEmpty: index === 4 || index === 6 // Items 5 and 7
          };
        });
        
        // Cache the results
        localStorage.setItem('listicleItems_' + userGoals, JSON.stringify(items));
        
        console.log('Generated', items.length, 'items');
        return items;
        
      } catch (error) {
        console.error('API error:', error);
        return getFallbackItems(userGoals, userInterests, userFavourites);
      }
    }

    function getFallbackItems(userGoals, userInterests, userFavourites) {
      return [
        {
          title: "You Tell Yourself 'Just One More Thing'",
          body: "It starts innocently enough. You're researching, planning, preparing. But one article becomes ten, and suddenly hours have passed. Sound familiar?"
        },
        {
          title: "You've Perfected the Art of Preparation",
          body: "You know everything about how to start. You've read the guides, watched the tutorials, made the plans. But knowing and doing are two different things, aren't they?"
        },
        {
          title: "Tomorrow Always Seems Like a Better Day",
          body: "You promise yourself tomorrow will be different. Tomorrow you'll have more energy, more time, more motivation. But tomorrow never comes."
        },
        {
          title: `${userInterests[0]} Seems More Important Right Now`,
          body: `You know you want to work on ${userGoals}, but there's always something about ${userInterests[0]} that needs your attention first. Just one more minute, you tell yourself.`
        },
        {
          title: "You've Read This Before",
          body: "",
          isEmpty: true
        },
        {
          title: `You're Reading This at 3:21 AM Instead of Acting`,
          body: `Let's not pretend anymore. You're a Filipino college student in Metro Manila, probably lying in bed or sitting at your desk, reading about ${userGoals} instead of actually doing it. How many nights has it been?`
        },
        {
          title: "I feel like I've read this before.",
          body: "",
          isEmpty: true
        },
        {
          title: "You Make Elaborate Plans",
          body: "You've outlined every step, created schedules, bought supplies. Planning feels like progress. But it's just another way to delay the actual work."
        },
        {
          title: "You're Reading This Article Right Now",
          body: "Instead of actually doing the thing. You're here, consuming more content, hoping this article will be the one that finally motivates you. Will it?"
        },
        {
          title: "You're Sitting in a Classroom at Ateneo Right Now",
          body: `Maybe it's the fine arts building, maybe another hall. You're supposed to be working on your creative project. But instead, you're here, reading about ${userGoals}, probably wondering how this article knows. The algorithm sees everything.`
        }
      ];
    }

    function renderListicle(items) {
      const container = document.getElementById('listicle-items');
      container.innerHTML = '';

      items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.id = `item-${index + 1}`;

        if (item.isEmpty) {
          itemDiv.innerHTML = `
            <div class="item-number">${index + 1}</div>
            <div class="item-body empty-item">
              <div class="item-title">${item.title}</div>
            </div>
            <div class="clear"></div>
          `;
        } else {
          itemDiv.innerHTML = `
            <div class="item-number">${index + 1}</div>
            <div class="item-body">
              <div class="item-title">${item.title}</div>
              <div class="item-text">${item.body}</div>
            </div>
            <div class="clear"></div>
          `;
        }

        container.appendChild(itemDiv);
      });

      console.log('Listicle rendered');
    }

    function generateComments(userGoals, userInterests, sessionId) {
      const comments = [
        { author: "nostalgic99", text: "This is so relatable! I've been putting things off for months." },
        { author: "procrastinator_pro", text: `Same here! I keep saying I'll ${userGoals} but never do.` },
        { author: "anonymous_user", text: `"${userGoals}" - wow, that's exactly what I've been avoiding too!` },
        { author: "future_reader", text: "Reading this in 2026, still relevant!" },
        { author: "tab_closer", text: "I'm about to close this tab too, just like the article predicted." },
        { author: "meta_commenter", text: "I don't know, do you think this article is a good idea or is it too on the nose?" },
        { author: "ateneo_student", text: "I have to present today after this session :(" },
        { author: "data_curious", text: userInterests.join(', ') },
        { author: "confused_reader", text: "This is a new tab. How did it get the preferences I listed from the previous tab?" },
        { author: "ERROR_USER", text: '<a href="page3.html" target="_blank" style="color: #b21; font-weight: bold;">Something is wrong. Something is very wrong.</a>' }
      ];

      const commentsList = document.getElementById('comments-list');
      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.innerHTML = `<strong>${comment.author}</strong> says:<br>${comment.text}`;
        commentsList.appendChild(commentDiv);
      });
    }

    function generateSidebar(userGoals, userInterests) {
      const sidebarLinks = document.getElementById('sidebar-links');
      const articles = [
        `Why ${userInterests[0]} Fans Struggle With ${userGoals}`,
        `10 Signs You're Avoiding ${userGoals}`,
        `If You Love ${userInterests[0]} But Can't ${userGoals}`,
        `AD: "${userGoals}" - Start Today!`
      ];

      articles.forEach(title => {
        const link = document.createElement('div');
        link.style.marginBottom = '10px';
        link.innerHTML = `<a href="page3.html" target="_blank">${title}</a>`;
        sidebarLinks.appendChild(link);
      });
    }

    function applyGlitchEffects() {
      const allText = document.querySelectorAll('p, .item-title, .item-text, .comment');
      
      // Random flicker
      setInterval(() => {
        const randomElement = allText[Math.floor(Math.random() * allText.length)];
        if (randomElement && Math.random() > 0.7) {
          randomElement.classList.add('flicker');
          setTimeout(() => randomElement.classList.remove('flicker'), 500);
        }
      }, 3000);
      
      // Random word repetition
      setInterval(() => {
        const randomP = document.querySelectorAll('.item-text')[Math.floor(Math.random() * document.querySelectorAll('.item-text').length)];
        if (randomP && Math.random() > 0.8) {
          const words = randomP.textContent.split(' ');
          const randomIndex = Math.floor(Math.random() * words.length);
          words[randomIndex] = words[randomIndex] + ' ' + words[randomIndex];
          randomP.textContent = words.join(' ');
        }
      }, 5000);
      
      // Random size change
      setInterval(() => {
        const randomElement = allText[Math.floor(Math.random() * allText.length)];
        if (randomElement && Math.random() > 0.85) {
          randomElement.classList.add('grow');
          setTimeout(() => randomElement.classList.remove('grow'), 1000);
        }
      }, 4000);

      console.log('Glitch effects activated');
    }

    function setupAutoScroll() {
      // Auto-scroll to bottom after 3 seconds
      setTimeout(() => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
      }, 3000);

      // Auto-open page3 when scrolling near bottom
      let bottomTriggered = false;
      window.addEventListener('scroll', function() {
        if (bottomTriggered) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
          bottomTriggered = true;
          setTimeout(function() {
            window.open('page3.html', '_blank');
          }, 5000);
        }
      });
    }
  </script>
</body>
</html>