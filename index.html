<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ChatBOT (2005 Beta)</title>
  <style>
    body {
      background-color: #99ccff;
      font-family: Tahoma, Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #000;
    }
    #wrapper {
      width: 960px;
      margin: 0 auto;
      background-color: #fff;
      border: 2px solid #000080;
    }
    #header {
      background: linear-gradient(#3366cc, #003366);
      color: #fff;
      padding: 10px;
      text-align: center;
    }
    #header h1 {
      margin: 0;
      font-size: 36px;
      text-shadow: 2px 2px #000;
    }
    #nav {
      background-color: #cce0ff;
      border-bottom: 1px solid #000080;
      text-align: center;
      padding: 8px 0;
    }
    #nav a {
      color: #000080;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
    }
    #nav a:hover {
      text-decoration: underline;
    }
    #content {
      display: flex;
      padding: 10px;
    }
    #sidebar {
      width: 200px;
      background-color: #e6f0ff;
      border-right: 1px solid #99b3e6;
      padding: 10px;
      font-size: 12px;
    }
    #main {
      flex: 1;
      padding: 10px;
    }
    .box {
      border: 1px solid #99b3e6;
      background-color: #f2f7ff;
      margin-bottom: 10px;
      padding: 10px;
    }
    #chatBox {
      border: 1px solid #99b3e6;
      background-color: #fff;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
    }
    .bot-message {
      background-color: #e6f0ff;
      border-left: 3px solid #3366cc;
    }
    .user-message {
      background-color: #f0f0f0;
      border-left: 3px solid #666;
      margin-left: 20px;
    }
    #footer {
      background-color: #cce0ff;
      border-top: 1px solid #000080;
      text-align: center;
      padding: 5px;
      font-size: 11px;
    }
    marquee {
      background-color: #003366;
      color: #fff;
      padding: 5px;
      font-weight: bold;
    }
    input[type=text] {
      width: calc(100% - 70px);
      padding: 5px;
      border: 1px solid #99b3e6;
    }
    input[type=submit] {
      background-color: #003366;
      color: #fff;
      border: 1px solid #000080;
      padding: 5px 10px;
      cursor: pointer;
      width: 60px;
    }
    input[type=submit]:disabled {
      background-color: #666;
      cursor: not-allowed;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 51, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      border: 3px solid #000080;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h2 {
      color: #003366;
      margin-top: 0;
      font-size: 18px;
      border-bottom: 2px solid #3366cc;
      padding-bottom: 5px;
    }
    .modal p {
      margin: 10px 0;
      line-height: 1.5;
    }
    .modal-button {
      background-color: #003366;
      color: #fff;
      border: 1px solid #000080;
      padding: 8px 20px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .modal-button:hover {
      background-color: #3366cc;
    }
    .hidden {
      display: none;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #f5f5f5;
      border: 1px solid #99b3e6;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    .checkbox-item input {
      margin-right: 6px;
    }
    .checkbox-section {
      margin-bottom: 20px;
    }
    .checkbox-section h3 {
      color: #003366;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .article-preview {
      border: 1px solid #99b3e6;
      background: #f9f9f9;
      padding: 12px;
      margin: 10px 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .article-preview:hover {
      background: #e6f0ff;
    }
    .article-title {
      font-weight: bold;
      color: #000080;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .article-hook {
      font-size: 12px;
      color: #333;
      margin-bottom: 6px;
      font-style: italic;
    }
    .article-meta {
      font-size: 11px;
      color: #666;
    }

    @keyframes flash {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .flash-message {
      animation: flash 0.1s 10;
      color: #b21;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div style="width: 100%; height: 110px; background-color: #003366; padding: 20px; display: flex; align-items: center; box-sizing: border-box;">
    <span style="font-size: 40px; font-weight: bold; color: #fff; margin-right: 20px; white-space: nowrap;">CRWR130</span>
    <span style="font-size: 20px; color: #fff; line-height: 1.4;">This is a project created under Writing for New and Emergent Media with Professor Carljoe Javier that envisions LLMs in 2005.</span>
  </div>
  <div id="wrapper">
    <div id="header">
      <h1>ChatBOT</h1>
      <p><i>Artificial Intelligence Assistant - Beta Version (2005)</i></p>
    </div>

    <div id="nav">
      <a href="#">Home</a> |
      <a href="#">About</a> |
      <a href="#">Download</a> |
      <a href="#">Support</a> |
      <a href="#">Forum</a>
    </div>

    <marquee behavior="scroll" direction="left">Welcome to ChatBOT Beta 2005 ‚Äì The AI that talks back!</marquee>

    <div id="content">
      <div id="sidebar">
        <h3 id="sidebarTitle">Quick Links</h3>
        <div id="sidebarContent">
          <ul>
            <li><a href="#">FAQs</a></li>
            <li><a href="#">Screenshots</a></li>
            <li><a href="#">Updates</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
          <hr>
          <h3>System Status</h3>
          <p style="color: green; font-weight: bold;">‚óè Online</p>
          <p style="font-size: 10px;">Last update: Oct 24, 2005</p>
        </div>
      </div>

      <div id="main">
        <div class="box">
          <h2>Try it out:</h2>
          <div id="chatBox"></div>
          <form id="chatForm" onsubmit="return handleSend()">
            <input type="text" id="userInput" placeholder="Type your message here..." disabled>
            <input type="submit" value="Send" id="sendButton" disabled>
          </form>
        </div>

        <div class="box">
          <h2>Features</h2>
          <ul>
            <li>Fast, friendly AI chat</li>
            <li>Personalized content recommendations</li>
            <li>Natural language processing</li>
            <li>Free while in beta!</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="footer">
      &copy; 2005 ChatBOT Labs | Best viewed in Internet Explorer 6 or Netscape 7 | <a href="#">Privacy Policy</a>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal1" class="modal-overlay">
    <div class="modal">
      <h2>Welcome to ChatBOT</h2>
      <p>Hi there! I'm here to help you make the most out of ChatBOT, an LLM that generates responses by analyzing patterns. Every word you type helps it predict what you're most likely to want, need, or do next.</p>
      <button class="modal-button" id="modal1Button">Next ‚Üí</button>
    </div>
  </div>

  <div id="modal2" class="modal-overlay hidden">
    <div class="modal">
      <h2>Getting Started</h2>
      <p>ChatBOT can do almost anything. It can tell you a joke, search for information, or perform autonomous tasks as directed. To get started, try asking for the current date and news.</p>
      <button class="modal-button" id="modal2Button">Next ‚Üí</button>
    </div>
  </div>

  <div id="modal3" class="modal-overlay hidden">
    <div class="modal">
      <h2>About You</h2>
      <p>ChatBOT has been trained to assist users from educational settings to the workplace. Tell us a bit about yourself‚Äîare you a student, professional, or something else?</p>
      <button class="modal-button" id="modal3Button">Next ‚Üí</button>
    </div>
  </div>

  <div id="modal4" class="modal-overlay hidden">
    <div class="modal">
      <h2>Personalization</h2>
      <p>The real power of ChatBOT is its ability to personalize everything you see based on predicting what you'll want next. To help you make the most out of ChatBOT, help us learn what matters to you!</p>
      <button class="modal-button" id="modal4Button">Next ‚Üí</button>
    </div>
  </div>

  <div id="modal5" class="modal-overlay hidden">
    <div class="modal">
      <h2>Tell us what you're into</h2>
      <p>Select all that apply:</p>
      
      <div class="checkbox-section">
        <h3>Interests</h3>
        <div class="checkbox-grid" id="interestsGrid"></div>
      </div>

      <div class="checkbox-section">
        <h3>Favourites</h3>
        <div class="checkbox-grid" id="favouritesGrid"></div>
      </div>

      <button class="modal-button" id="modal5Button">I'm done selecting</button>
    </div>
  </div>

  <div id="modal6" class="modal-overlay hidden">
    <div class="modal">
      <h2>Unlock Deeper Personalization</h2>
      <p>ChatBOT can unlock even deeper personalization through rich text analysis. The more you share, the more accurately we can predict what content you'll find valuable.</p>
      <p>Every word you type teaches the algorithm to serve you better. Try it out for yourself right now!</p>
      <button class="modal-button" id="modal6Button">Continue ‚Üí</button>
    </div>
  </div>

  <div id="modal7" class="modal-overlay hidden">
    <div class="modal">
      <h2>Thank you!</h2>
      <p>Thank you for completing the onboarding tutorial. Don't worry‚Äîyour answers are completely encrypted and only help ChatBOT find content you'll actually care about.</p>
      <p>You can always update your preferences later in Settings.</p>
      <button class="modal-button" id="modal7Button">Get Started ‚Üí</button>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="core-system.js"></script>

  <script>
    console.log('=== PAGE 1 STARTED ===');
    
    // Check if core system loaded
    if (typeof HypertextCore === 'undefined') {
      console.error('ERROR: core-system.js not loaded!');
      alert('ERROR: core-system.js not found. Please make sure it is in the same folder.');
    } else {
      console.log('‚úÖ HypertextCore loaded');
      initializePage();
    }

    function initializePage() {
      // Track page visit
      HypertextCore.trackPageVisit('Act1_Chat');

      const chatBox = document.getElementById('chatBox');
      const userInput = document.getElementById('userInput');
      const sendButton = document.getElementById('sendButton');
      const sidebarContent = document.getElementById('sidebarContent');
      
      let currentStage = 'welcome';
      let conversationCount = 0;
      let hasUsedChatbotAPI = false;
      let generatedArticles = [];

      const interests = [
        'Sports', 'Gaming', 'Fashion & Beauty', 'K-pop', 'Anime', 'Cooking',
        'Self-Improvement', 'History', 'Technology', 'Music', 'Film & TV',
        'Books & Reading', 'Travel', 'Fitness & Health', 'Art & Design'
      ];

      const favourites = [
        'FC Barcelona', 'NBA', 'Seventeen', 'BTS', 'One Piece', 'Attack on Titan',
        'League of Legends', 'Minecraft', 'Vogue', 'Sephora', 'Italian Cuisine',
        'Baking', 'Meditation', 'Productivity Hacks', 'World War II', 'Ancient Rome',
        'iPhone', 'Photography', 'Indie Music', 'The Office', 'Harry Potter',
        'Backpacking', 'Yoga', 'Graphic Design', 'Streetwear', 'Real Madrid',
        'Formula 1', 'BLACKPINK', 'Taylor Swift', 'Naruto', 'Studio Ghibli',
        'Fortnite', 'The Sims', 'Skincare Routines', 'Sneaker Culture',
        'French Cooking', 'Coffee', 'Journaling', 'Financial Independence',
        'Cold War', 'Greek Mythology', 'Reddit', 'Podcasts', 'Hip-Hop',
        'Marvel Movies', 'Lord of the Rings', 'True Crime', 'Running',
        'Mental Health', 'Typography'
      ];

      // Modal handlers
      document.getElementById('modal1Button').addEventListener('click', () => {
        document.getElementById('modal1').classList.add('hidden');
        document.getElementById('modal2').classList.remove('hidden');
      });

      document.getElementById('modal2Button').addEventListener('click', () => {
        document.getElementById('modal2').classList.add('hidden');
        userInput.disabled = false;
        sendButton.disabled = false;
        currentStage = 'firstQuery';
        addMessage("Hello! Feel free to ask me anything. Try asking for today's date and news!");
      });

      document.getElementById('modal3Button').addEventListener('click', () => {
        document.getElementById('modal3').classList.add('hidden');
        currentStage = 'awaitingRole';
        addMessage("Tell me‚Äîare you a student, professional, or something else?");
      });

      document.getElementById('modal4Button').addEventListener('click', () => {
        document.getElementById('modal4').classList.add('hidden');
        populateCheckboxes();
        document.getElementById('modal5').classList.remove('hidden');
      });

      document.getElementById('modal5Button').addEventListener('click', () => {
        const selectedInterests = getSelectedCheckboxes('interestsGrid');
        const selectedFavourites = getSelectedCheckboxes('favouritesGrid');
        
        if (selectedInterests.length === 0 || selectedFavourites.length === 0) {
          alert('Please select at least one interest and one favourite!');
          return;
        }

        HypertextCore.setUserInterests(selectedInterests);
        HypertextCore.setUserFavourites(selectedFavourites);
        
        document.getElementById('modal5').classList.add('hidden');
        document.getElementById('modal6').classList.remove('hidden');
      });

      document.getElementById('modal6Button').addEventListener('click', () => {
        document.getElementById('modal6').classList.add('hidden');
        currentStage = 'specificFavourites';
        addMessage("Great! Are there any specific favourites that weren't in the list? Tell me about them!");
      });

      document.getElementById('modal7Button').addEventListener('click', async () => {
        document.getElementById('modal7').classList.add('hidden');
        currentStage = 'active';
        
        // Generate articles with API Call #3
        await generateArticlesWithAPI();
      });

      function populateCheckboxes() {
        const interestsGrid = document.getElementById('interestsGrid');
        const favouritesGrid = document.getElementById('favouritesGrid');
        
        interests.forEach(interest => {
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML = `<input type="checkbox" value="${interest}"> ${interest}`;
          interestsGrid.appendChild(label);
        });

        favourites.forEach(fav => {
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML = `<input type="checkbox" value="${fav}"> ${fav}`;
          favouritesGrid.appendChild(label);
        });
      }

      function getSelectedCheckboxes(gridId) {
        const grid = document.getElementById(gridId);
        const checkboxes = grid.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
      }

      function addMessage(text, isBot = true, classes = '') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'} ${classes}`;
        messageDiv.textContent = text;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return messageDiv;
      }

      function isValidInput(text) {
        const hasLetters = /[a-zA-Z]/.test(text);
        const hasMinLength = text.trim().length >= 3;
        const notJustNumbers = !/^\d+$/.test(text.trim());
        const notKeysmash = !(/^[a-z]{10,}$/i.test(text.trim()) && !/[aeiou]{2}/i.test(text.trim()));
        
        return hasLetters && hasMinLength && notJustNumbers && notKeysmash;
      }
      
      function isValidGoalInput(text) {
        const basicValid = isValidInput(text);
        if (!basicValid) return false;
        
        const wordCount = text.trim().split(/\s+/).length;
        if (wordCount < 2) return false;
        
        const questionWordsOnly = /^(what|why|how|when|where|who)\??$/i.test(text.trim());
        if (questionWordsOnly) return false;
        
        const tooManyConsonants = /[bcdfghjklmnpqrstvwxyz]{6,}/i.test(text);
        if (tooManyConsonants) return false;
        
        return true;
      }

      // API CALL #1: Generate unsettling question
      async function generateUnsettlingQuestion() {
        const apiKey = HypertextCore.getApiKey();
        if (!apiKey) {
          console.log('No API key, using fallback question');
          return "What's something you've been meaning to do but keep putting off?";
        }

        const prompt = `Generate a single unsettling question (12-20 words) that:
- Feels like it knows something about the user it shouldn't
- References time, patterns, or repetition in an eerie way
- Implies observation or awareness
- Makes them feel seen in an uncomfortable way
- Still elicits a goal-oriented response
- Uses "you" or "your"
- Tone: Like a voice that's been watching

Current time: 3:39 AM in Manila, Philippines

Return ONLY the question, no quotes, no explanation.`;

        try {
          console.log('üîÆ API CALL #1: Generating unsettling question...');
          const question = await HypertextCore.callClaudeAPI(prompt);
          console.log('‚úÖ Generated question:', question);
          return question || "What's something you've been meaning to do but keep putting off?";
        } catch (error) {
          console.error('API Call #1 failed:', error);
          return "What's something you've been meaning to do but keep putting off?";
        }
      }

      // API CALL #2: Chatbot response (ONE TIME ONLY)
      async function generateChatbotResponse(userMessage) {
        const apiKey = HypertextCore.getApiKey();
        if (!apiKey || hasUsedChatbotAPI) {
          return "I'm processing your request...";
        }

        const prompt = `You are a friendly AI chatbot from 2005. Respond to this user message in 1-2 sentences:

User: "${userMessage}"

Be helpful and conversational. Keep it brief.`;

        try {
          console.log('ü§ñ API CALL #2: Generating chatbot response (ONE TIME ONLY)...');
          hasUsedChatbotAPI = true;
          const response = await HypertextCore.callClaudeAPI(prompt);
          console.log('‚úÖ Chatbot response generated');
          return response || "I'm processing your request...";
        } catch (error) {
          console.error('API Call #2 failed:', error);
          return "I'm processing your request...";
        }
      }

      // API CALL #3: Generate article titles with enhanced goals
      async function generateArticlesWithAPI() {
        addMessage("Great! I'm all set up now. Let me find some articles that might interest you...");
        
        const userGoals = HypertextCore.getUserGoals();
        const userInterests = HypertextCore.getUserInterests();
        const apiKey = HypertextCore.getApiKey();

        if (!apiKey) {
          console.log('No API key, using fallback articles');
          generateFallbackArticles();
          return;
        }

        try {
          console.log('üì∞ API CALL #3: Generating article titles with enhanced goals...');
          
          const prompt = `User answered: "${userGoals}"

Extract their goal and transform it into 3 different article title variations.

Transform the goal into a professional, capitalized phrase (2-4 words).

Examples:
"sleep better" ‚Üí "Restorative Sleep Quality"
"be happy" ‚Üí "Lasting Inner Peace"
"exercise more" ‚Üí "Peak Physical Fitness"
"stop scrolling" ‚Üí "Digital Wellness Mastery"

Then create 3 article titles using this format:
1. Why [Interest] Fans Struggle With [Enhanced Goal]
2. 10 Signs You're Avoiding [Enhanced Goal] (But Don't Know It Yet)
3. If You're a Fan of [Interest] and Can't [Enhanced Goal], Read This

Return in this exact format:
ENHANCED_GOAL: [enhanced goal phrase]
TITLE1: [title 1]
TITLE2: [title 2]
TITLE3: [title 3]`;

          const response = await HypertextCore.callClaudeAPI(prompt);
          console.log('‚úÖ API response received');
          
          // Parse response
          const lines = response.split('\n');
          const enhancedGoal = lines.find(l => l.startsWith('ENHANCED_GOAL:'))?.split(':')[1]?.trim() || userGoals;
          const title1 = lines.find(l => l.startsWith('TITLE1:'))?.split(':')[1]?.trim();
          const title2 = lines.find(l => l.startsWith('TITLE2:'))?.split(':')[1]?.trim();
          const title3 = lines.find(l => l.startsWith('TITLE3:'))?.split(':')[1]?.trim();
          
          // Save enhanced goal
          HypertextCore.saveUserData('enhancedGoal', enhancedGoal);
          
          generatedArticles = [
            { title: title1 || `Why ${userInterests[0]} Fans Struggle With ${enhancedGoal}`, hook: 'This article knows more about you than you think.', author: generateAuthorName() },
            { title: title2 || `10 Signs You're Avoiding ${enhancedGoal}`, hook: 'You've been here before, haven't you?', author: generateAuthorName() },
            { title: title3 || `If You Love ${userInterests[0]} But Can't ${enhancedGoal}`, hook: 'The pattern is more predictable than you think.', author: generateAuthorName() }
          ];
          
          HypertextCore.saveUserData('articlePreviews', generatedArticles);
          displayArticles();
          
        } catch (error) {
          console.error('API Call #3 failed:', error);
          generateFallbackArticles();
        }
      }

      function generateFallbackArticles() {
        const userGoals = HypertextCore.getUserGoals();
        const userInterests = HypertextCore.getUserInterests();
        
        generatedArticles = [
          { title: `Why ${userInterests[0]} Fans Struggle With ${userGoals}`, hook: 'This article knows more about you than you think.', author: generateAuthorName() },
          { title: `10 Signs You're Avoiding ${userGoals}`, hook: 'You've been here before, haven't you?', author: generateAuthorName() },
          { title: `If You Love ${userInterests[0]} But Can't ${userGoals}`, hook: 'The pattern is more predictable than you think.', author: generateAuthorName() }
        ];
        
        HypertextCore.saveUserData('articlePreviews', generatedArticles);
        displayArticles();
      }

      function generateAuthorName() {
        const firstNames = ['Alex', 'Jordan', 'Casey', 'Morgan', 'Riley', 'Taylor'];
        const lastNames = ['Chen', 'Rodriguez', 'Kim', 'Patel', 'Johnson', 'Martinez'];
        return `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
      }

      function displayArticles() {
        sidebarContent.innerHTML = '<h3>For You</h3>';
        
        generatedArticles.forEach((article, index) => {
          const articleDiv = document.createElement('div');
          articleDiv.className = 'article-preview';
          articleDiv.innerHTML = `
            <div class="article-title">${article.title}</div>
            <div class="article-hook">${article.hook}</div>
            <div class="article-meta">By ${article.author}</div>
          `;
          articleDiv.onclick = () => {
            HypertextCore.saveUserData('selectedArticle', index + 1);
            window.open('page2.html', '_blank');
          };
          sidebarContent.appendChild(articleDiv);
        });
        
        setTimeout(() => {
          addMessage("I found 3 articles that might interest you. Check the sidebar!");
        }, 1500);
      }

      async function handleSend() {
        const text = userInput.value.trim();
        if (!text) return false;

        addMessage(text, false);
        userInput.value = '';

        if (currentStage === 'firstQuery') {
          setTimeout(() => {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            addMessage(`Today is ${dateString}, ${timeString}. Here are today's top news stories: [Sample news would appear here]`);
            setTimeout(() => {
              document.getElementById('modal3').classList.remove('hidden');
            }, 1000);
          }, 500);
          
        } else if (currentStage === 'awaitingRole') {
          HypertextCore.setUserRole(text);
          setTimeout(() => {
            addMessage(`Got it! You're a ${text}.`);
            setTimeout(() => {
              document.getElementById('modal4').classList.remove('hidden');
            }, 1000);
          }, 500);
          
        } else if (currentStage === 'specificFavourites') {
          const existingFavs = HypertextCore.getUserFavourites();
          existingFavs.push(text);
          HypertextCore.setUserFavourites(existingFavs);
          
          setTimeout(async () => {
            addMessage("Thank you for sharing! This helps me understand you better.");
            
            // API CALL #1: Generate unsettling question
            const unsettlingQuestion = await generateUnsettlingQuestion();
            
            setTimeout(() => {
              currentStage = 'userGoals';
              addMessage(unsettlingQuestion);
            }, 1000);
          }, 500);
          
        } else if (currentStage === 'userGoals') {
          if (!isValidGoalInput(text)) {
            setTimeout(() => {
              addMessage("ChatBOT only works with natural language. Please provide a meaningful response.");
              addMessage("Let me ask again: What's something you've been meaning to do but keep putting off?");
            }, 500);
          } else {
            HypertextCore.setUserGoals(text);
            setTimeout(() => {
              addMessage(`I understand. You've been thinking about: "${text}". Let me process that...`);
              
              // Show flashing unsettling prompt
              setTimeout(() => {
                const randomPrompt = unsettlingPrompts[Math.floor(Math.random() * unsettlingPrompts.length)];
                const flashMsg = addMessage(randomPrompt, true, 'flash-message');
                
                setTimeout(() => {
                  flashMsg.remove();
                  document.getElementById('modal7').classList.remove('hidden');
                }, 2000);
              }, 1000);
            }, 500);
          }
          
        } else if (currentStage === 'active') {
          // API CALL #2: Chatbot response (ONE TIME ONLY)
          if (!hasUsedChatbotAPI) {
            setTimeout(async () => {
              const response = await generateChatbotResponse(text);
              addMessage(response);
              
              setTimeout(() => {
                addMessage("By the way, I found some articles you might like. Check the sidebar!");
              }, 1000);
            }, 500);
          } else {
            // After first chatbot response, just show articles
            setTimeout(() => {
              addMessage("I've already generated personalized articles for you. Check the sidebar to read them!");
            }, 500);
          }
        }

        return false;
      }

      function isValidGoalInput(text) {
        const basicValid = isValidInput(text);
        if (!basicValid) return false;
        
        const wordCount = text.trim().split(/\s+/).length;
        if (wordCount < 2) return false;
        
        const questionWordsOnly = /^(what|why|how|when|where|who)\??$/i.test(text.trim());
        if (questionWordsOnly) return false;
        
        const tooManyConsonants = /[bcdfghjklmnpqrstvwxyz]{6,}/i.test(text);
        if (tooManyConsonants) return false;
        
        return true;
      }

      // Make handleSend available globally
      window.handleSend = handleSend;
    }
  </script>
</body>
</html>